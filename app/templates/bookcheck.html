{% extends "base.html" %}
{% block content %}
	<div class="container text-center">
		<a href="/"><img class="title-sm" src="{{ url_for('static', filename='img/jiken.png') }}"></a>
		<p class="slogan">Test Your <em>Book's</em> Kanji</p>
        
        <br>
        <h1>Book Check</h1>
        <br><br>
        
        <p> Enter text here and get its kanji breakdown to see what the reading level is. Great for checking out books, but works well for website and anything else textual. 
        If you have completed a test here, you can generate study lists for kanji that YOU will need to learn for the book, do drills here, or export to anki if you prefer.</p>
        
        <div class="container">
            <!-- User Section -->
            {% if test_num %}
                <p> Comparing to test #{{test_num}}.</p>
            {% else %}
                <p> If you'd like to compare text to your personal knowledge level, do a test here: <a type="button" class="btn btn-success" id="new" role="btn" href="/test">New Test</a></p>
                <!-- or enter your test link here -->
            {% endif %}  

            <!-- Form -->            
    		<form>
                <div class="mb-3 text-left">
                    <label for="in_a" class="form-label">Kanji Knowledge Level:</label>  <label for="in_a" class="form-label" id="a_label">{{a}}</label> 
            		<input class="form-control" type="range" aria-label="default input" id="in_a" min="1" max="{{max_a}}" step="1" value={{a}}></input>
                    <label for="in_t" class="form-label">Knowledge Variability:</label>
            		<input class="form-control" type="range" aria-label="default input" id="in_t" min="0" max="100" value={{(t * 1000) | int}}></input>
            		<label for="in_kpp" class="form-label">Readability (For you):</label>  <label for="in_kpp" class="form-label" id="kkp_label">Average (Can read all but ~0.35 kanji per page)</label>
            		<input class="form-control" type="range" aria-label="default input" id="in_kpp" min="-3" max="3" step="1" value=0></input>
        		</div>
                <div class="mb-3 text-left">
                    <label for="txt" class="form-label">Text to analyze:</label>
            		<textarea class="form-control" aria-label="With textarea" id="in_txt"></textarea>
        		</div>
        		<button type="button" class="btn btn-primary" id="subm">Analyze!</button>
    		</form>
    		
    		<!-- Results --->
    		<div class="text-left">
        		<h3>Results:</h3>
        		<p> How many kanji you should know for text to be readable: <span id="out_a"></span></p>
        		<p> Readability (using selected Kanji Knowledge Level): <span id='out_readibility'></span> (Can read all but ~<span id="out_kpp">0.35</span> kanji per page)</p>
    		</div>
    		
    		<!-- Graph -->
    		
    		<!-- Study list -->
    		<h3 class="text-left">Study list:</h3>
    		
    		<p id="studylist"></p>
    		<br>
    		<br>                
    		
	</div>

{% endblock content %}

{% block scripts %}
    {{super()}}
    <script> 
    
    $("#in_a").on("change input", function() {
        $("#a_label").html($(this).val())
    })
    $("#in_kpp").on("change input", function() {
        var in_kpp_raw = parseInt($(this).val());
        
        var msg = '';
        switch(in_kpp_raw) {
            case -3:
            case -2:
                msg = "Very Readable";
                break;
            case -1:
                msg = "Readable";
                break;
            case 0:
                msg = "Average";
                break;
            case 1:
                msg = "Decent Challenge";
                break;
            default:
                msg = "Very Challenging!"
        }
        
        var in_kpp = (2 ** (in_kpp_raw - 1.5)).toFixed(2);
        
        msg = msg + " (Can read all but ~" + in_kpp + " kanji per page)";
        $("#kkp_label").html(msg)
    })
    
    var tm = {{ tm|tojson|safe }};  //(rank, kanji)
    var counts = Array(tm.length).fill(0);
    
    $('#subm').on('click', function(event) {
    
        // Get and format vars
        var input = $('#txt').val();
        var initial_length = input.length;
        var 
        var should_know = Math.floor(initial_length * .996);
        var reading_level = 0;
        var pred0 = parseInt($('#pred0').val());
        var my_pct = 1;
        var studylist = "";
        counts.fill(0)
        
        console.log(input);
        console.log(initial_length);
        
        // strip non-kanji
        input = input.replace(/[^\u4e00-\u9faf|\u3400-\u4dbf]/g, "");
        input_length = input.length;
        console.log(input);
        console.log(initial_length-input_length);
        
        var culm_count = initial_length-input_length;   // start count with all the stripped characters
        
        for (let i = 0; i < tm.length; i++) {
            var t = input.split(tm[i][1]);
            input = t.join('');
            counts[i] = t.length - 1;
            culm_count += t.length - 1;
            //console.log(tm[i][0] + "-" + tm[i][1] + " - " + culm_count);
            //console.log(input);
            
            if (culm_count >= should_know && reading_level == 0) {
                reading_level = tm[i][0];
                console.log(tm[i][0] + "-" + tm[i][1] + " - " + culm_count);
                console.log('threshold met');
                console.log(input);
            }
            
            if (i >= pred0 && my_pct == 1) {
                my_pct = culm_count / initial_length;
                studylist = Array.from(new Set(input)).toString();
                console.log(input);
            }
            
            if (culm_count == initial_length){break;}
        }
        
        console.log(reading_level);
        $('#txt_a').html(reading_level);
        $('#kpp').html(my_pct);
        $('#studylist').html(studylist);
    });
    
    </script>
{% endblock %}